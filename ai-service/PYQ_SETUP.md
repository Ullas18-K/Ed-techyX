# PYQ (Previous Year Questions) System - Setup Guide

## ğŸ“ Directory Structure Created

```
ai-service/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ pyqs/
â”‚       â”œâ”€â”€ pdfs/          â† PUT YOUR PDF FILES HERE
â”‚       â””â”€â”€ images/        â† Auto-generated (extracted diagrams)
â”œâ”€â”€ models/
â”‚   â””â”€â”€ pyq_schemas.py     â† PYQ data models
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ pyq_generator.py   â† Hybrid RAG + Gemini generator
â””â”€â”€ utils/
    â””â”€â”€ pyq_ingestion.py   â† PDF processing with Gemini Vision
```

## ğŸš€ Quick Start

### Step 1: Add Your PYQ PDFs

Place your PDF files in:
```
ai-service/data/pyqs/pdfs/
```

**File naming convention (optional but recommended):**
- `pyq_science_2023.pdf`
- `pyq_science_2022.pdf`
- `biology_pyq_2021.pdf`

The system will auto-detect years from filenames.

### Step 2: Ingest PDFs

**Option A: Via API (FastAPI Swagger)**

1. Start server: `python main.py`
2. Open: http://localhost:8001/docs
3. Find `POST /admin/ingest-pyqs`
4. Click "Try it out" â†’ "Execute"
5. Wait for background processing to complete (check logs)

**Option B: Via Python Script**

```python
from utils.pyq_ingestion import ingest_all_pyqs
from rag.retriever import RAGRetriever

rag_retriever = RAGRetriever()
results = await ingest_all_pyqs(rag_retriever)
print(results)
```

### Step 3: Test PYQ Retrieval

**Via Swagger UI:**
1. Open: http://localhost:8001/docs
2. Find `POST /api/questions/practice`
3. Request body:
```json
{
  "topic": "photosynthesis",
  "grade": 10,
  "subject": "science",
  "count": 5,
  "includeGenerated": true
}
```

**Via Python:**
```python
import requests

response = requests.post("http://localhost:8001/api/questions/practice", json={
    "topic": "ray optics",
    "grade": 10,
    "subject": "science",
    "count": 5
})

data = response.json()
print(f"Got {data['totalCount']} questions")
print(f"  - {data['pyqCount']} from PDFs")
print(f"  - {data['generatedCount']} generated by Gemini")
```

## ğŸ–¼ï¸ How Image Handling Works

### During Ingestion:
1. **Extract images** from PDF pages
2. **Save to disk** as PNG files
3. **Analyze with Gemini Vision** (describes diagram)
4. **Store description** in vector DB

### During Retrieval:
- Questions with images include `imageUrl` field
- Frontend can display: `/api/assets/pyqs/images/filename.png`
- Image description available for accessibility

## ğŸ“Š Response Format

```json
{
  "questions": [
    {
      "questionId": "pyq_ray_optics_0_2023",
      "questionText": "A ray of light strikes a plane mirror at 45Â°...",
      "topic": "ray_optics",
      "subject": "science",
      "grade": 10,
      "year": 2023,
      "difficulty": "medium",
      "hasImage": true,
      "imageUrl": "/api/assets/pyqs/images/ray_optics_2023_p1_img0.png",
      "imageDescription": "Diagram showing a ray of light incident on a plane mirror at 45 degrees to the normal. The incident ray, reflected ray, and normal are labeled...",
      "answer": "According to the law of reflection, angle of incidence equals angle of reflection. Since the ray strikes at 45Â°, it will reflect at 45Â° on the opposite side of the normal...",
      "answerExplanation": "...",
      "source": "pyq",
      "sourcePdf": "pyq_science_2023",
      "pageNumber": 3
    },
    {
      "questionId": "gen_ray_optics_10_0",
      "questionText": "Explain the principle of a concave mirror...",
      "hasImage": false,
      "answer": "A concave mirror converges light rays...",
      "source": "generated"
    }
  ],
  "totalCount": 5,
  "pyqCount": 3,
  "generatedCount": 2,
  "topic": "ray_optics",
  "grade": 10
}
```

## ğŸ¯ Hybrid Approach Logic

```python
# Automatic behavior:
RAG retrieves questions â†’ If < requested count â†’ Gemini generates more

Example:
- Request 5 questions on "photosynthesis"
- RAG finds 2 PYQs
- Gemini generates 3 supplementary questions
- Returns 5 total (2 real + 3 generated)
```

## ğŸ”§ Configuration

### Disable Gemini Generation

```json
{
  "topic": "...",
  "count": 5,
  "includeGenerated": false  // Only return PYQs from PDFs
}
```

### Difficulty Filtering

```json
{
  "topic": "...",
  "difficulty": "hard"  // Options: easy, medium, hard
}
```

## ğŸ“¸ Image Serving

Images are served at:
```
GET /api/assets/pyqs/images/{filename}
```

Frontend usage:
```tsx
<img src={question.imageUrl} alt={question.imageDescription} />
```

## ğŸ§ª Testing

### Check Ingestion Status
```bash
# Check vector DB stats
curl http://localhost:8001/api/rag/stats

# Search for PYQs
curl -X POST "http://localhost:8001/api/rag/search?query=previous%20year%20question%20photosynthesis&top_k=5"
```

### Sample Topics to Test
- photosynthesis
- ray optics
- human eye
- electricity
- chemical reactions
- reproduction in plants

## ğŸ’° Cost Optimization

**Gemini API Calls:**
1. **During Ingestion** (one-time): ~$0.005 per image analyzed
2. **During Generation** (when RAG < 5): ~$0.003 per request

**Caching Strategy:**
- Generated questions are cached in memory
- First request generates â†’ subsequent requests use cache
- Restart server to clear cache

## ğŸ› Troubleshooting

### "No questions found"
- Check if PDFs were ingested: `GET /api/rag/stats`
- Try broader topic name
- Set `includeGenerated: true`

### "Image not found"
- Check `data/pyqs/images/` directory
- Re-run ingestion if images missing

### Gemini Vision errors
- Verify GCP credentials are valid
- Check Gemini 2.0 Flash is enabled in project

## ğŸ“ PDF Format Requirements

Your PDFs should have:
- âœ… Text-based questions (not scanned images)
- âœ… Optional: Diagrams/images embedded
- âœ… Optional: Answers included
- âœ… Questions numbered (Q1, Q2, etc.)

**If PDFs are scanned images:**
You'll need OCR preprocessing (pytesseract is already imported).

## ğŸš€ Next Steps

1. **Add more PDFs** â†’ Better coverage
2. **Customize difficulty** â†’ Add metadata during ingestion
3. **Topic tagging** â†’ Improve with better question parsing
4. **Answer generation** â†’ Gemini fills in missing answers

---

## Example Frontend Integration

```tsx
import { useState } from 'react';

function PracticeQuestions({ topic, grade }) {
  const [questions, setQuestions] = useState([]);

  async function loadQuestions() {
    const res = await fetch('http://localhost:8001/api/questions/practice', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        topic,
        grade,
        subject: 'science',
        count: 5,
        includeGenerated: true
      })
    });
    
    const data = await res.json();
    setQuestions(data.questions);
  }

  return (
    <div>
      <button onClick={loadQuestions}>Load Questions</button>
      
      {questions.map(q => (
        <div key={q.questionId}>
          <h3>{q.questionText}</h3>
          
          {q.hasImage && (
            <img 
              src={`http://localhost:8001${q.imageUrl}`}
              alt={q.imageDescription}
            />
          )}
          
          <details>
            <summary>View Answer</summary>
            <p>{q.answer}</p>
          </details>
          
          <small>
            {q.source === 'pyq' 
              ? `PYQ ${q.year} - Page ${q.pageNumber}` 
              : 'AI Generated'}
          </small>
        </div>
      ))}
    </div>
  );
}
```

---

**Your PYQ system is ready! Put PDFs in `data/pyqs/pdfs/` and call `/admin/ingest-pyqs`**
